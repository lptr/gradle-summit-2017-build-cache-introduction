= Build cache: _much_ faster builds
:title-slide-background-image: title.jpeg
:title-slide-transition: zoom
:title-slide-transition-speed: fast
:revnumber: {project-version}
ifndef::imagesdir[:imagesdir: images]
ifndef::sourcedir[:sourcedir: ../java]
:deckjs_transition: fade
:navigation:™
:menu:
:status:
:icons: font

Lóránt Pintér (https://twitter.com/lptr[@lptr]), Gradle

== Agenda

* What's new and what isn't
* What can you expect today
* What's next

== Incremental build

[cols="2*a"]
|===
|
*Designed for:*

* local development
* one change at a time
|image:history-linear.png[Moving forward in history,75%,75%]
|===

=== How it works

1. check inputs
2. check outputs
3. profit! (if all the same)

=== Metadata

[source,groovy]
----
class CustomTask extends DefaultTask {
  @InputDirectory
  File sourceDirectory

  @OutputFile
  File outputFile

  // ...
}
----

=== Limitations

* works only locally
* optimized for incremental changes
* _"best-effort"_

== Build cache

_is-a_ *semi-permanent storage*

_(with a few tricks...)_

=== Task output caching

_is-a_ feature using the build cache where:

* the *content* is the task's _outputs,_
* the *address* is the task's _inputs._

=== How it works

1. hash task inputs into _cache key_
2. load task outputs from cache
3. profit!

=== Local cache

[cols="2*a"]
|===
|
*Useful when:*

* working on branches
* `git bisect`
|image:history-branches.png[Moving around in history,75%,75%]
|===

=== Shared cache

[cols="2*a"]
|===
|
*Implementations:*

* HTTP build cache
* Gradle Enterprise build cache
|image:ge-build-cache.png[GE build cache,100%,100%]
|===

=== Shared cache on CI

[cols="2*a"]
|===
|
*Reuse outputs:*

* between changesets
* between CI agents
* between CI jobs
|image:ci-jobs.png[CI jobs,100%,100%]
|===

=== ...and for developers

* no need to rebuild other people's changes

== How much _faster?_

*33.9%*

=== Gradle's CI #1

Code quality checks: *-25.7%*

image::cache-gains-stage-1.png[Cache gains -- stage 1,100%,100%]

Hours saved: *3*

=== Gradle's CI #2

Linux & Windows integration tests: *-33.9%*

image::cache-gains-stage-3.png[Cache gains -- stage 3,100%,100%]

Hours saved: *62*

=== Gradle developers

- slow connections
- geographically diverse
- one big `:core` module with 30%+ of the code

_7.96% time saved_

== "Best effort"

* uses same metadata__*__ as incremental build
* more permanent, no `clean` to fix problems

_* -- that can be faulty_

=== Fix it for good

=== For third-party tasks

* more warnings
* enforce exclusive outputs
* disable caching when unsafe
* later: better isolation

=== Fixes in Gradle

* better stale file cleanup
* track Java version
* remove Java-Groovy compilation overlap

=== Improved documentation

* user guide chapter for inputs and outputs
* build cache guide

=== New problems with sharing outputs

* non-homogenous environments
** OS, locale, env. vars
** tool versions installed

* new concept: *relocatability*
** where's your `$HOME`?

=== Relocatability

[source,groovy]
----
class CustomTask extends DefaultTask {

  @PathSensitive(PathSensitivity.RELATIVE)
  @InputDirectory
  File sourceDirectory

  // ...
}
----

=== Path sensitivity

* `ABSOLUTE` -- is the default
* `RELATIVE` -- discards common directory part
* `NAME_ONLY` -- keeps the file name only
* `NONE` -- ignores path completely

=== We want to go slow

* opt-in: tasks are marked with `@CacheableTask`
** no support for custom tasks yet
* Java projects supported in Gradle 4.0
* caching support coming in Android plugin 3.0
* full Scala, Groovy and native support coming

[%notitle]
=== Example

[source,groovy]
----
@CacheableTask
class ConcatenateTask extends DefaultTask {
  @PathSensitive(PathSensitivity.NONE)
  @InputFiles FileCollection sourceFiles
  @OutputFile File outputFile

  @TaskAction
  void concatenate() {
    outputFile.createNewFile()
    sourceFiles.each {
      outputFile << it.text + '\n'
    }
  }
}
----


== Summary

* like _incremental build,_ but works across time and space
* we need to do more work
* you need to do some work
* Java support available
* Android, native support coming
* custom tasks later

=== Roadmap

* Incremental build ✅
* Task output caching ✅
* Containerized build
* Distributed build


== Other talks

* *Moving existing builds towards full cacheability*
** Tomorrow 1pm in MEDITERRANEAN III
** _Stefan Wolf_ and _Sterling Greene_
* *Maximizing incrementality*
** Tomorrow 4.40pm in MEDITERRANEAN III
** _Cédric Champeau_


== More resources

* Slides:
** https://github.com/lptr/gradle-summit-2017-build-cache-introduction[]
* Build Cache Guide:
** https://guides.gradle.org/using-build-cache[]
* Gradle Enterprise cache:
** https://gradle.com/build-cache[]

Learn more at https://gradle.org[gradle.org]

[%notitle]
== Thanks
image::outro.jpeg[background, size=cover]
